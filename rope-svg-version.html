<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>elastic rope</title>
</head>

<body style="margin: 0px" color="black">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100vh">
        <rect width="100%" height="100%" fill="#22222b" /></svg>

    <script>
        class Point {
            constructor(x, y, mass, fixed) {
                this.x = x || 0;
                this.y = y || 0;
                this.mass = mass || 1.0;
                this.massInv = 1.0 / this.mass;
                this.fixed = fixed || false;
            }
            move(x, y) {
                this.x = this.x + x;
                this.y = this.y + y;
            }
        }
        class Line {
            constructor(p1, p2, restLength, strength) {
                this.p1 = p1;
                this.p2 = p2;
                this.restLength = restLength || 10;
                this.strength = strength || 1.0;
                this.gravity = false;
            }
            update() {
                // Compute desired force
                let dx = this.p2.x - this.p1.x,
                    dy = this.p2.y - this.p1.y,
                    dd = Math.sqrt(dx * dx + dy * dy),
                    tf = (dd + this.restLength) / (dd * (this.p1.massInv + this.p2.massInv)) * this.strength,
                    f;

                // Apply forces
                if (!this.p1.fixed && this.gravity) {
                    f = tf * this.p1.massInv;
                    this.p1.x += dx * f;
                    this.p1.y += dy * f + Math.log(this.p1.mass * this.p1.y) / Math.log(Math.floor(this.p1.y));
                }

                if (!this.p2.fixed && this.gravity) {
                    f = -tf * this.p2.massInv;
                    this.p2.x += dx * f;
                    this.p2.y += dy * f + Math.log(this.p2.mass * this.p2.y) / Math.log(Math.floor(this.p2.y));
                }
            };
        }

        function createLine(svg, jack, xPosition, yPosition) {
            let lines = [];
            let count = 12;
            let pointsString = "";
            let initalPosition = "";
            let animationID = undefined;
            let shape = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            let shapeUnfoldAnimation = document.createElementNS("http://www.w3.org/2000/svg", "animate");
            let shapeFoldAnimation = document.createElementNS("http://www.w3.org/2000/svg", "animate");
            let jackRotateAnimation = document.createElementNS("http://www.w3.org/2000/svg", "animateMotion");
            let points = [ // inital hanging shape:
                new Point(0.378, 1.056, 0.4, true),
                new Point(2.695, 2.016, 0.4),
                new Point(4.831, 3.454, 0.4),
                new Point(6.789, 5.335, 0.4),
                new Point(8.575, 7.623, 0.4),
                new Point(10.192, 10.284, 0.4),
                new Point(11.646, 13.281, 0.4),
                new Point(14.078, 20.143, 0.4),
                new Point(15.909, 27.926, 0.4),
                new Point(17.173, 36.348, 0.4),
                new Point(17.906, 45.122, 0.4, true),
                new Point(18.142, 53.970, 0.4, true)
            ]

            // shape.onclick = () => {
            //     svg.removeChild(shape);
            // }

            svg.appendChild(shape);
            svg.appendChild(jack);

            points.forEach((point, i) => {
                point.move(xPosition, yPosition);
                if (i > 0) {
                    let newLine = new Line(points[i - 1], points[i], Math.log(point.x), 0.8)
                    lines.push(newLine);
                }
                pointsString += `${point.x},${point.y} `;
                initalPosition += `${points[0].x},${points[0].y} `;
            })

            shape.setAttribute("stroke", "#040404");
            shape.setAttribute("fill", "none");
            shape.setAttribute("stroke-width", "2");
            shape.setAttribute("points", pointsString);
            shape.setAttribute("stroke-dasharray", "60");

            shapeUnfoldAnimation.setAttribute("attributeName", "stroke-dashoffset");
            shapeUnfoldAnimation.setAttribute("from", "60");
            shapeUnfoldAnimation.setAttribute("to", "0");
            shapeUnfoldAnimation.setAttribute("dur", "1s");
            shapeUnfoldAnimation.setAttribute("fill", "freeze");

            shape.appendChild(shapeUnfoldAnimation);
            shapeUnfoldAnimation.beginElement()

            // remove old animation. This can't be done differently as I hate svg translate
            document.getElementById("jack-animation") && jack.removeChild(document.getElementById("jack-animation"))

            jackRotateAnimation.setAttribute("path",`m ${0.378+xPosition} ${1.056+yPosition} c 13.622 3.944 18.622 34.944 17.622 52.944`);
            jackRotateAnimation.setAttribute("begin", "0s");
            jackRotateAnimation.setAttribute("id", "jack-animation");
            jackRotateAnimation.setAttribute("dur", "1s");
            jackRotateAnimation.setAttribute("rotate", "auto");
            jackRotateAnimation.setAttribute("fill", "freeze");

            jack.appendChild(jackRotateAnimation)
            jackRotateAnimation.beginElement();

            jackRotateAnimation.onend = () => {
                shape.setAttribute("points", pointsString);
                shape.removeAttribute("stroke-dasharray")
            }

            let calculatePhysics = () => {
                pointsString = "";

                shape.onmouseover = () => {
                    shape.style.cursor = "no-drop"
                }

                lines.forEach((line) => {
                    line.update()
                })

                points.forEach((point) => {
                    pointsString += `${point.x},${point.y} `;
                });

                shape.setAttribute("points", pointsString);

                animationID = window.requestAnimationFrame(calculatePhysics)
            };

            jack.onmousedown = function (event) {
                jack.style.opacity = "0";

                svg.style = "cursor: url('./img/jack_cleared.svg'), auto;"

                // values set like this so it looks cool
                points[count - 1].x = event.offsetX + 2.5;
                points[count - 1].y = event.offsetY + 4.75;
                points[count - 2].x = event.offsetX - 3;
                points[count - 2].y = event.offsetY + 4.75;

                lines.forEach((line) => {
                    line.gravity = true
                })

                calculatePhysics();

                svg.onmousemove = function (event) {
                    points[count - 1].x = event.offsetX + 2.5;
                    points[count - 1].y = event.offsetY + 4.75;
                    points[count - 2].x = event.offsetX - 3;
                    points[count - 2].y = event.offsetY + 4.75;
                }

                svg.onmouseup = () => {
                    jack.style.opacity = "1"

                    // give some time for a physic calculation to finish
                    setTimeout(() => {
                        window.cancelAnimationFrame(animationID);
                    }, 100);

                    svg.style.cursor = "default";
                    svg.onmousedown = undefined;
                    svg.onmousemove = undefined;
                    svg.onmouseup = undefined;

                    shapeFoldAnimation.setAttribute("attributeName", "points");
                    shapeFoldAnimation.setAttribute("from", pointsString);
                    shapeFoldAnimation.setAttribute("to", initalPosition);
                    shapeFoldAnimation.setAttribute("dur", "0.5s");
                    shapeFoldAnimation.setAttribute("fill", "freeze");

                    shape.appendChild(shapeFoldAnimation);
                    shapeFoldAnimation.beginElement();

                    shapeFoldAnimation.onend = () => {
                        svg.removeChild(shape);
                    }

                    createLine(svg, jack, 150, 150);
                }
            }

        }

        let svg = document.getElementById('svg');
        let jack = document.createElementNS("http://www.w3.org/2000/svg", "image");

        jack.setAttribute("href", "./img/jack_cleared.svg");
        jack.setAttribute("height", "9");
        jack.setAttribute("y", "-4.5")

        jack.onmouseover = () => {
            svg.style.cursor = "grab"
        }
        jack.onmouseout = () => {
            if (svg.style.cursor === "grab") svg.style = "cursor: default";
        }

        createLine(svg, jack, 150, 150)
    </script>
</body>
</html>